const backpackSkins = [
"alphabet (G, R, A, N and D)",
  "alphabet (G)",
  "alphabet (R)",
  "alphabet (A)",
  "alphabet (N)",
  "alphabet (D)",
  "animal juice",
  "animal skin",
  "arena container",
  "attack juice",
  "10% attack juice",
  "20% attack juice",
  "25% attack juice",
  "automatic drill",
  "automatic oil well",
  "automatic rod",
  "automatic sawmill",
  "automatic watering can",
  "power armored vest skin",
  "power armored vest skin (V.1)",
  "power armored vest skin (V.2)",
  "power armored vest skin (V.3)",
  "alcohlic beverage cheetah",
  "battery",
  "batteries",
  "Benefactor container",
  "big fireworks",
  "binoculars",
  "body armour skin",
  "high quality brakes",
  "medium quality brakes",
  "low quality brakes",
  "baltic beer",
  "blazzzer alcohlic beverage",
  "burglarized house container",
  "backpack space (low, medium, high & max quality)",
  "max quality backpack space",
  "high quality backpack space",
  "medium quality backpack space",
  "low quality backpack space",
  "small Birthday gift",
  "big Birthday gift",
  "tokens",
  "cabbage",
  "cabbage seeds",
  "campfire",
  "caravan container",
  "carp",
  "Cayo Perico tickets",
  "chair",
  "chair 1",
  "chair 2",
  "chair 3",
  "chair 4",
  "chair 5",
  "chair 6",
  "Christmas lollipop",
  "Christmas tree of type 1",
  "Christmas tree of type 2",
  "Christmas tree of type 3",
  "Christmas tree of type 4",
  "Christmas tree of type 5",
  "cigarettes",
  "coblevo wine",
  "container for bikers 1",
  "container for bikers 2",
  "container for bikers 3",
  "container for bikers 4",
  "container for bikers 5",
  "container for branded shorts",
  "container for branded t-shirts",
  "container for drifters 1",
  "container for drifters 2",
  "container for drifters 3",
  "container for men 1",
  "container for men 2",
  "container for racers 1",
  "container for racers 2",
  "container for racers 3",
  "container for women 1",
  "container for women 2",
  "container with wheels 1",
  "container with wheels 2",
  "container with wheels 3",
  "copper",
  "daily container",
  "desert scarf mask container",
  "diamond",
  "dice",
  "double paycheck juice",
  "drawing print",
  "prints",
  "elixir",
  "electric chargers",
  "emerald",
  "endurance juice",
  "high quality engine",
  "medium quality engine",
  "low quality engine",
  "exclusive truckers container",
  "explosive fireworks",
  "earplugs",
  "fast running juice",
  "fish",
  "high quality fishing rod",
  "medium quality fishing rod",
  "low quality fishing rod",
  "flag",
  "flowers",
  "fruit",
  "fuel canister",
  "fuel for resource extraction",
  "red fabric",
  "blue fabric",
  "yellow fabric",
  "green fabric",
  "purple fabric",
  "gardeners container",
  "gasoline barrels",
  "grand ticket",
  "GrandPro bodycam",
  "grill",
  "hookah",
  "high quality metal",
  "immunity juice",
  "ingrand container",
  "10% juice",
  "20% juice",
  "25% juice",
  "kerosene barrels",
  "leash",
  "license plate",
  "lottery tickets",
  "love container",
  "luminous stone",
  "mandarin seeds",
  "mandarins",
  "map of Los Santos",
  "milk",
  "mining resources",
  "multivitamin juice",
  "mushroom seeds",
  "mushrooms",
  "Monowheel",
  "neon armored vest skin",
  "neon armored vest skin (V.1)",
  "neon armored vest skin (V.2)",
  "neon armored vest skin (V.3)",
  "neon Muci armored vest skin",
  "neon Muci armored vest skin (V.1)",
  "neon Muci armored vest skin (V.2)",
  "neon Muci armored vest skin (V.3)",
  "neon Lui Vi armored vest skin",
  "neon Lui Vi armored vest skin (V.1)",
  "neon Lui Vi armored vest skin (V.2)",
  "neon Lui Vi armored vest skin (V.3)",
  "neon armored vest skin with chains",
  "neon armored vest skin with chains (V.1)",
  "neon armored vest skin with chains (V.2)",
  "neon armored vest skin with chains (V.3)",
  "neon Summer 2023 armored vest skin",
  "neon Summer 2023 armored vest skin (V.1)",
  "neon Summer 2023 armored vest skin (V.2)",
  "neon Summer 2023 armored vest skin (V.3)",
  "new year gift",
  "Ocelot container",
  "oil barrel",
  "organisation container",
  "old autumn gold container",
  "old winter gold container",
  "old summer gold container",
  "paint cans",
  "pearl",
  "perch",
  "pet",
  "pet border collie",
  "pet cat",
  "pet chicken",
  "pet Christmas elf",
  "pet dog",
  "pet duck",
  "pet food",
  "pet ghost",
  "pet golden retriever",
  "pet huggy wuggy",
  "pet husky",
  "pet kitty bunny",
  "pet monkey",
  "pet panda",
  "pet panther",
  "pet pig",
  "pet poodle",
  "pet pug",
  "pet puma",
  "pet pumpkin guardian",
  "pet rabbit",
  "pet rat",
  "pet rooster",
  "pet rottweiler",
  "pet Santa Claus",
  "pet voodoo doll",
  "pet westie",
  "pet X-mas husky",
  "pickaxe (low, medium & high quality)",
  "high quality pickaxe",
  "medium quality pickaxe",
  "low quality pickaxe",
  "pineapple seeds",
  "pineapples",
  "platinum prime ticket of type 7",
  "platinum prime ticket of type 10",
  "platinum prime ticket of type 15",
  "platinum prime ticket of type 20",
  "platinum prime ticket of type 21",
  "platinum prime ticket of type 30",
  "pool table",
  "port wine 666",
  "power booster",
  "power juice",
  "10% power juice",
  "20% power juice",
  "25% power juice",
  "premium fuel canister",
  "starter prime ticket of type 7",
  "starter prime ticket of type 10",
  "starter prime ticket of type 15",
  "starter prime ticket of type 20",
  "starter prime ticket of type 30",
  "Progen container",
  "protection juice",
  "10% protection juice",
  "20% protection juice",
  "25% protection juice",
  "pumpkin seeds",
  "pumpkins",
  "purifield water",
  "pet treat",
  "pet Fancy Bear",
  "repair kit",
  "resource scanner",
  "riding juice",
  "ruby/rubies",
  "resources container",
  "rare lottery tickets",
  "salmon",
  "sand",
  "sand figures",
  "scarecrow flag",
  "scrap metal",
  "shovel",
  "sim-cards",
  "Single fireworks",
  "snow",
  "snow figure of type 1/2/3",
  "snowballs",
  "solar barrel",
  "solar panel",
  "sphere of influence container",
  "prime ticket of type 3",
  "prime ticket of type 5",
  "prime ticket of type 7",
  "prime ticket of type 10",
  "prime ticket of type 15",
  "prime ticket of type 20",
  "prime ticket of type 30",
  "strawberries",
  "study of the organisation container",
  "Summer 2023 armoured vest skin",
  "Summer 2023 armoured vest skin (V.1)",
  "Summer 2023 armoured vest skin (V.2)",
  "Summer 2023 armoured vest skin (V.3)",
  "high quality suspension",
  "medium quality suspension",
  "low quality suspension",
  "school container",
  "snow figure of type 1",
  "snow figure of type 2",
  "snow figure of type 3",
  "tactical grand armored vest skin",
  "tent",
  "threads",
  "timber",
  "tincture of the forest mushrooms",
  "tokens",
  "high quality transmission",
  "medium quality transmission",
  "low quality transmission",
  "Trezor container",
  "trout",
  "dirty statue",
  "purified statue",
  "high quality tyres",
  "medium quality tyres",
  "low quality tyres",
  "tuning parts",
  "treasure map",
  "unique love container",
  "unique rims of type 1",
  "unique rims of type 2",
  "unique rims of type 3",
  "unique rims of type 4",
  "unique rims of type 5",
  "unique rims of type 6",
  "unique rims of type 7",
  "unique rims of type 8",
  "unique rims of type 9",
  "unique rims of type 10",
  "unique rims of type 11",
  "unique rims of type 12",
  "unique rims of type 13",
  "unique rims of type 14",
  "unique rims of type 15",
  "unique rims of type 16",
  "unique rims of type 17",
  "unique rims of type 18",
  "unique rims of type 19",
  "unique rims of type 20",
  "unique rims of type 21",
  "unique rims of type 22",
  "unique rims of type 23",
  "unique rims of type 24",
  "unique rims of type 25",
  "unique rims of type 26",
  "unique rims of type 27",
  "unique rims of type 28",
  "unique rims of type 29",
  "unique rims of type 30",
  "unique rims of type 31",
  "unique rims of type 32",
  "unique rims of type 33",
  "unique rims of type 34",
  "unique rims of type 35",
  "unique rims of type 36",
  "unique rims of type 37",
  "unique rims of type 38",
  "unique rims of type 39",
  "unique rims of type 40",
  "valuable container",
  "video card",
  "volcano fireworks",
  "vodka-shotka",
  "Valentine gift",
  "wire",
 "pet lion cub",
 "resource miners ticket",
];

class TransactionForm {
    constructor() {
        this.state = {
            type: 'selling',
            isTrading: false,
            items: ['', '', ''],
            prices: ['', '', ''],
            usePluralS: [false, false, false],
            useRespectively: false,
            activeItemCount: 1,
            useEach: [false, false, false],
            useInBulk: false // Add this property
        };

        this.initializeElements();
        this.attachEventListeners();
        this.updateUI();
    }

    initializeElements() {
        this.form = document.getElementById('transactionForm');
        this.itemsContainer = document.getElementById('itemsContainer');
        this.pricesContainer = document.getElementById('pricesContainer');
        this.preview = document.getElementById('preview');
        this.itemCount = document.getElementById('itemCount');
        this.itemsTitle = document.getElementById('itemsTitle');
        this.respectivelyCheck = document.querySelector('.respectively-check');
        this.itemControls = document.querySelector('.item-controls');
    }

    attachEventListeners() {
        document.querySelectorAll('input[name="transactionType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                this.state.type = e.target.value;
                this.updatePreview();
            });
        });

        document.getElementById('tradingOption').addEventListener('change', (e) => {
            this.state.isTrading = e.target.checked;
            this.state.activeItemCount = e.target.checked ? 2 : 1;
            this.updateUI();
            this.updatePreview();
        });

        document.getElementById('respectively').addEventListener('change', (e) => {
            this.state.useRespectively = e.target.checked;
            this.updatePreview();
        });
             
        document.getElementById('addItem').addEventListener('click', () => this.handleAddItem());
        document.getElementById('removeItem').addEventListener('click', () => this.handleRemoveItem());

        document.getElementById('copyButton').addEventListener('click', () => this.handleCopy());

        document.getElementById('inBulk').addEventListener('change', (e) => {
            this.state.useInBulk = e.target.checked;
            this.updatePreview();
        });
    }

    handleAddItem() {
        if (this.state.activeItemCount < 3 && !this.state.isTrading) {
            this.state.activeItemCount++;
            this.updateUI();
            this.updatePreview();
        }
    }

    handleRemoveItem() {
        if (this.state.activeItemCount > 1 && !this.state.isTrading) {
            this.state.activeItemCount--;
            this.updateUI();
            this.updatePreview();
        }
    }

    handleCopy() {
        const button = document.getElementById('copyButton');
        const originalContent = button.innerHTML;
        
        navigator.clipboard.writeText(this.preview.textContent);
        
        button.innerHTML = `
            <img src="https://cdn.jsdelivr.net/npm/lucide-static@0.344.0/icons/check.svg" width="16" height="16" alt="Copied" class="text-success">
            <span>Copied!</span>
        `;
        
        setTimeout(() => {
            button.innerHTML = originalContent;
        }, 2000);
    }

    createInputGroup(type, index) {
        const div = document.createElement('div');
        div.className = `${type}-input-group mb-3`;
        
        if (type === 'item') {
            const row = document.createElement('div');
            row.className = 'row g-2';

            const itemCol = document.createElement('div');
            itemCol.className = 'col';
            
            const inputGroup = document.createElement('div');
            inputGroup.className = 'input-group';
            
            const span = document.createElement('span');
            span.className = 'input-group-text';
            span.innerHTML = '<img src="https://cdn.jsdelivr.net/npm/lucide-static@0.344.0/icons/package.svg" width="16" height="16" alt="Item">';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control item-input';
            input.placeholder = this.state.isTrading
                ? (index === 0 ? 'Your item' : 'Wanted item')
                : `Item ${index + 1}`;
            
            input.value = this.state.items[index]?.split(' x ')[0] || '';
            
            input.addEventListener('input', (e) => {
                const quantity = this.state.items[index]?.split(' x ')[1] || '';
                this.state.items[index] = quantity ? `${e.target.value} x ${quantity}` : e.target.value;
                this.handleItemInput(e.target, index);
                this.updatePreview();
            });
            
            inputGroup.appendChild(span);
            inputGroup.appendChild(input);
            
            const suggestions = document.createElement('div');
            suggestions.className = 'suggestions d-none position-absolute w-100 bg-white border rounded-bottom shadow-sm';
            inputGroup.appendChild(suggestions);
            
            itemCol.appendChild(inputGroup);
            
            const quantityCol = document.createElement('div');
            quantityCol.className = 'col-3';
            
            const quantityInput = document.createElement('input');
            quantityInput.type = 'text';
            quantityInput.className = 'form-control';
            quantityInput.placeholder = 'Quantity';
            quantityInput.value = this.state.items[index]?.split(' x ')[1] || '';
            
            quantityInput.addEventListener('input', (e) => {
                const itemName = this.state.items[index]?.split(' x ')[0] || '';
                this.state.items[index] = e.target.value ? `${itemName} x ${e.target.value}` : itemName;
                this.updatePreview();
            });
            
            quantityCol.appendChild(quantityInput);
            
            const pluralCol = document.createElement('div');
            pluralCol.className = 'col-auto d-flex align-items-center mt-2';
            
            const pluralCheck = document.createElement('div');
            pluralCheck.className = 'form-check';
            
            const pluralInput = document.createElement('input');
            pluralInput.type = 'checkbox';
            pluralInput.className = 'form-check-input';
            pluralInput.id = `usePluralS${index}`;
            pluralInput.checked = this.state.usePluralS[index];
            
            pluralInput.addEventListener('change', (e) => {
                this.state.usePluralS[index] = e.target.checked;
                this.updatePreview();
            });
            
            const pluralLabel = document.createElement('label');
            pluralLabel.className = 'form-check-label';
            pluralLabel.htmlFor = `usePluralS${index}`;
            pluralLabel.textContent = 'Add "S"';
            
            pluralCheck.appendChild(pluralInput);
            pluralCheck.appendChild(pluralLabel);
            pluralCol.appendChild(pluralCheck);
            
            row.appendChild(itemCol);
            row.appendChild(quantityCol);
            div.appendChild(row);
            div.appendChild(pluralCol);
        } else {
            const row = document.createElement('div');
            row.className = 'row g-2';

            const priceCol = document.createElement('div');
            priceCol.className = 'col';

            const inputGroup = document.createElement('div');
            inputGroup.className = 'input-group';
            
            const span = document.createElement('span');
            span.className = 'input-group-text';
            span.textContent = '$';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control';
            input.placeholder = `Price for item ${index + 1}`;
            input.value = this.state.prices[index];
            
            input.addEventListener('input', (e) => {
                this.state.prices[index] = e.target.value;
                this.updatePreview();
            });
            
            inputGroup.appendChild(span);
            inputGroup.appendChild(input);
            priceCol.appendChild(inputGroup);

            const eachCol = document.createElement('div');
            eachCol.className = 'col-auto d-flex align-items-center';

            const eachCheck = document.createElement('div');
            eachCheck.className = 'form-check';

            const eachInput = document.createElement('input');
            eachInput.type = 'checkbox';
            eachInput.className = 'form-check-input';
            eachInput.id = `useEach${index}`;
            eachInput.checked = this.state.useEach[index];

            eachInput.addEventListener('change', (e) => {
                this.state.useEach[index] = e.target.checked;
                this.updatePreview();
            });

            const eachLabel = document.createElement('label');
            eachLabel.className = 'form-check-label';
            eachLabel.htmlFor = `useEach${index}`;
            eachLabel.textContent = 'Each';

            eachCheck.appendChild(eachInput);
            eachCheck.appendChild(eachLabel);
            eachCol.appendChild(eachCheck);

            row.appendChild(priceCol);
            row.appendChild(eachCol);
            div.appendChild(row);
        }
        
        return div;
    }

    handleItemInput(input, index) {
        const suggestionsDiv = input.parentElement.querySelector('.suggestions');
        const value = input.value.toLowerCase();
        
        if (value) {
            const filtered = backpackSkins.filter(skin =>
                skin.toLowerCase().includes(value)
            );
            
            if (filtered.length > 0) {
                suggestionsDiv.innerHTML = filtered.map(suggestion => `
                    <div class="suggestion-item">${suggestion}</div>
                `).join('');
                
                suggestionsDiv.classList.remove('d-none');
                
                suggestionsDiv.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const quantity = this.state.items[index]?.split(' x ')[1] || '';
                        this.state.items[index] = quantity ? `${item.textContent} x ${quantity}` : item.textContent;
                        input.value = item.textContent;
                        suggestionsDiv.classList.add('d-none');
                        this.updatePreview();
                    });
                });
            } else {
                suggestionsDiv.classList.add('d-none');
            }
        } else {
            suggestionsDiv.classList.add('d-none');
        }
    }

    updateUI() {
        this.itemsTitle.textContent = this.state.isTrading ? 'Trading Items' : 'Items';
        this.itemControls.style.display = this.state.isTrading ? 'none' : 'flex';
        this.itemCount.textContent = `${this.state.activeItemCount} of 3`;
        
        this.itemsContainer.innerHTML = '';
        this.pricesContainer.innerHTML = '';
        
        const count = this.state.isTrading ? 2 : this.state.activeItemCount;
        for (let i = 0; i < count; i++) {
            this.itemsContainer.appendChild(this.createInputGroup('item', i));
            this.pricesContainer.appendChild(this.createInputGroup('price', i));
        }
        
        this.respectivelyCheck.classList.toggle('d-none', this.state.activeItemCount <= 1);
        
        document.getElementById('addItem').disabled = this.state.activeItemCount >= 3;
        document.getElementById('removeItem').disabled = this.state.activeItemCount <= 1;
    }

    formatPrice(price) {
        if (!price) return '';
    
        let cleanPrice = price.toString().toLowerCase().replace(/[^0-9km.]/g, '');
        let numericValue;
    
        if (cleanPrice.includes('k')) {
            numericValue = parseFloat(cleanPrice.replace('k', '')) * 1000;
            if (!isNaN(numericValue)) {
                // Replace commas with periods in the formatted output
                return `$${numericValue.toLocaleString('en-US', { minimumFractionDigits: 0 }).replace(/,/g, '.')}`;
            }
        } else if (cleanPrice.includes('m')) {
            numericValue = parseFloat(cleanPrice.replace('m', '')) * 1000000;
            if (!isNaN(numericValue)) {
                return `$${(numericValue / 1000000).toFixed(0)} Million`; // No change for "Million"
            }
        } else {
            numericValue = parseFloat(cleanPrice);
            if (!isNaN(numericValue)) {
                // Replace commas with periods in the formatted output
                return `$${numericValue.toLocaleString('en-US', { minimumFractionDigits: 0 }).replace(/,/g, '.')}`;
            }
        }
    
        return ''; // Return empty string for invalid input
    }

    formatTransaction() {
        const { type, items, prices, useRespectively, activeItemCount, isTrading, useEach, usePluralS, useInBulk } = this.state;

        const validItems = items.slice(0, isTrading ? 2 : activeItemCount).filter(item => item.trim());
        if (validItems.length === 0) return '';

        if (isTrading) {
            if (validItems.length !== 2) return '';

            const [item1, quantity1] = validItems[0].split(' x ');
            const [item2, quantity2] = validItems[1].split(' x ');

            let formattedItem1 = item1.trim();
            let formattedItem2 = item2.trim();

            if (usePluralS[0] && !formattedItem1.endsWith('s')) {
                formattedItem1 = `${formattedItem1}s`;
            }
            if (usePluralS[1] && !formattedItem2.endsWith('s')) {
                formattedItem2 = `${formattedItem2}s`;
            }

            const item1Text = quantity1 ? `${quantity1.trim()} ${formattedItem1}` : formattedItem1;
            const item2Text = quantity2 ? `${quantity2.trim()} ${formattedItem2}` : formattedItem2;

            let output = `Trading ${item1Text} for ${item2Text}`;

            if (useInBulk) {
                output += ' in bulk';
            }

            const validPrices = prices.slice(0, 2).map(price => price.trim()).filter(price => price);
            if (validPrices.length > 0) {
                const priceText = validPrices.map((price, index) => {
                    const formattedPrice = this.formatPrice(price);
                    const suffix = useEach[index] ? ' each' : '';
                    return `${formattedPrice}${suffix}`;
                }).join(' and ');

                output += `. Price: ${priceText}`;
            } else {
                output += `. Price: Negotiable.`;
            }

            // Ensure the output ends with a full stop if it ends with an alphabetic character
            if (/[a-zA-Z]$/.test(output)) {
                output += '.';
            }

            return output;
        }

        const capitalizedType = type.charAt(0).toUpperCase() + type.slice(1);
        const formattedItems = validItems.map((item, index) => {
            const [itemName, quantity] = item.split(' x ');

            let modifiedItemName = itemName.trim();
            if (usePluralS[index] && !modifiedItemName.endsWith('s')) {
                modifiedItemName = `${modifiedItemName}s`;
            }

            let formattedItem = quantity ? `${quantity.trim()} ${modifiedItemName}` : modifiedItemName;

            if (validItems.length === 3) {
                if (index === 0) return formattedItem;
                if (index === 1) return `, ${formattedItem}`;
                return ` and ${formattedItem}`;
            } else if (validItems.length === 2) {
                if (index === 0) return formattedItem;
                return ` and ${formattedItem}`;
            }
            return formattedItem;
        }).join('');

        let output = `${capitalizedType} ${formattedItems}`;

        if (useInBulk) {
            output += ' in bulk';
        }

        const validPrices = prices
            .slice(0, activeItemCount)
            .map(price => price.trim())
            .filter(price => price);

        if (validPrices.length > 0) {
            const priceText = validPrices.map((price, index) => {
                const formattedPrice = this.formatPrice(price);
                const suffix = useEach[index] ? ' each' : '';

                if (validPrices.length === 3) {
                    if (index === 0) return formattedPrice + suffix;
                    if (index === 1) return `, ${formattedPrice}${suffix}`;
                    return ` and ${formattedPrice}${suffix}`;
                } else if (validPrices.length === 2) {
                    if (index === 0) return formattedPrice + suffix;
                    return ` and ${formattedPrice}${suffix}`;
                }
                return formattedPrice + suffix;
            }).join('');

            if (validPrices.length === 1) {
                output += `. ${type === 'buying' ? 'Budget' : 'Price'}: ${priceText}`;
            } else if (useRespectively && validPrices.length === validItems.length) {
                output += `. ${type === 'buying' ? 'Budget' : 'Price'}: ${priceText} respectively`;
            } else {
                output += `. ${type === 'buying' ? 'Budget' : 'Price'}: ${priceText}`;
            }
        } else {
            output += `. ${type === 'buying' ? 'Budget' : 'Price'}: Negotiable.`;
        }

        // Ensure the output ends with a full stop if it ends with an alphabetic character
        if (/[a-zA-Z]$/.test(output)) {
            output += '.';
        }

        return output;
    }
    

    updatePreview() {
        const output = this.formatTransaction();
        this.preview.textContent = output || 'Complete the form to generate your transaction description';
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new TransactionForm();
    
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.input-group')) {
            document.querySelectorAll('.suggestions').forEach(s => {
                s.classList.add('d-none');
            });
        }
});
});